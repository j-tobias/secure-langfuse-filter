# Secure Langfuse Filter

A privacy-preserving [OpenWebUI Pipeline Filter](https://docs.openwebui.com/pipelines/) that sends usage telemetry to [Langfuse](https://langfuse.com/) without storing conversation content or user-identifiable information.

Adapted from the [upstream example filter](https://github.com/open-webui/pipelines/blob/main/examples/filters/langfuse_v3_filter_pipeline.py).

## What Gets Tracked

- Token usage (input/output counts from the model)
- Model used (ID and human-readable name)
- Response time (ms)
- Chat title and tags (auto-generated by OpenWebUI)
- Hashed user ID (SHA-256, not reversible)
- Message stats (count, roles, character counts, estimated tokens)

## What Is Never Sent

- Conversation content (not redacted — simply never sent; only aggregate char counts are computed)
- User email, name, avatar, or any PII
- Template variables containing user information

## Privacy Measures

- **Hashed user ID** — User emails are SHA-256 hashed before being sent to Langfuse. This provides a stable, anonymous handle per user without exposing the actual email.
- **Metadata sanitisation** — All user-identifiable fields (`user`, `name`, `email`, `profile_image_url`, `avatar`, etc.) are stripped from metadata. PII keys inside the `variables` dict are also removed via substring pattern matching.
- **Content exclusion** — No message content is ever sent to Langfuse. The filter reads content only to compute `len()` for aggregate statistics; the text itself is never serialised or stored.
- **Chat enrichment** — OpenWebUI's auto-generated chat titles and tags are captured and stored in Langfuse trace metadata for categorisation, without exposing actual conversation content.
- **Response time tracking** — Elapsed time (inlet → outlet) is recorded in generation metadata as `response_time_ms`.
- **Memory management** — Stale chat state is automatically cleaned up after 24h of inactivity to prevent unbounded memory growth.

## Configuration

| Valve | Default | Description |
|-------|---------|-------------|
| `secret_key` | env `LANGFUSE_SECRET_KEY` | Langfuse secret key |
| `public_key` | env `LANGFUSE_PUBLIC_KEY` | Langfuse public key |
| `host` | env `LANGFUSE_HOST` | Langfuse host URL |
| `insert_tags` | `true` | Add task names as Langfuse trace tags |
| `use_model_name_instead_of_id_for_generation` | `false` | Use human-readable model name in generations |

## Documentation

| Document | Description |
|----------|-------------|
| [Architecture Overview](ARCHITECTURE.md) | High-level design and links to all docs |
| [OpenWebUI Metadata](docs/OPENWEBUI-METADATA.md) | `body`, `metadata`, `user`, task types, message formats |
| [Langfuse Integration](docs/LANGFUSE-INTEGRATION.md) | Trace lifecycle, SDK methods, token usage, error handling |
| [Privacy Model](docs/PRIVACY-MODEL.md) | Sanitisation layers, PII detection, threat model |
| [Configuration](docs/CONFIGURATION.md) | Valves, env variables, memory management, lifecycle hooks |

