# Secure Langfuse Filter

A privacy-preserving [OpenWebUI Pipeline Filter](https://docs.openwebui.com/pipelines/) that sends usage telemetry to [Langfuse](https://langfuse.com/) without storing conversation content or user-identifiable information.

Adapted from the [upstream example filter](https://github.com/open-webui/pipelines/blob/main/examples/filters/langfuse_v3_filter_pipeline.py).

## What Gets Tracked

- Token usage (input/output counts)
- Model used (ID and human-readable name)
- Response time (ms)
- Chat title and tags (auto-generated by OpenWebUI for fuzzy categorisation)
- Hashed user ID (for aggregate per-user analytics, not traceable)
- Message structure (role, count, character/word/token estimates)

## What Is Never Sent

- Conversation content (replaced with size summaries when `redact_content=True`)
- User email, name, avatar, or any PII
- Template variables containing user information

## Privacy Measures

- **Hashed user ID** — User emails are SHA-256 hashed before being sent to Langfuse. This provides a stable, anonymous handle per user without exposing the actual email.
- **Metadata sanitisation** — All user-identifiable fields (`user`, `name`, `email`, `profile_image_url`, `avatar`, etc.) are stripped from metadata. PII keys inside the `variables` dict are also removed via substring pattern matching.
- **Body sanitisation** — Top-level PII fields are removed from the request body before it is logged as trace input.
- **Content redaction** (`redact_content` valve, **on by default**) — All message text is replaced with `[REDACTED | 523 chars | 98 words | ~131 tokens]`. Multi-modal content (images) is also redacted.
- **Chat enrichment** — OpenWebUI's auto-generated chat titles and tags are captured and stored in Langfuse trace metadata for categorisation, without exposing actual conversation content.
- **Response time tracking** — Elapsed time (inlet → outlet) is recorded in trace metadata as `response_time_ms`.
- **Memory management** — Stale chat state is automatically cleaned up after 24h of inactivity to prevent unbounded memory growth in long-running servers.

## Configuration

| Valve | Default | Description |
|-------|---------|-------------|
| `secret_key` | env `LANGFUSE_SECRET_KEY` | Langfuse secret key |
| `public_key` | env `LANGFUSE_PUBLIC_KEY` | Langfuse public key |
| `host` | env `LANGFUSE_HOST` | Langfuse host URL |
| `insert_tags` | `true` | Add task names as Langfuse trace tags |
| `use_model_name_instead_of_id_for_generation` | `false` | Use human-readable model name in generations |
| `redact_content` | `true` | Replace message content with size summaries |
| `debug` | `false` | Enable debug logging (sanitised — never logs raw content) |

## Documentation

| Document | Description |
|----------|-------------|
| [Architecture Overview](ARCHITECTURE.md) | High-level design and links to all docs |
| [OpenWebUI Metadata](docs/OPENWEBUI-METADATA.md) | `body`, `metadata`, `user`, task types, message formats |
| [Langfuse Integration](docs/LANGFUSE-INTEGRATION.md) | Trace lifecycle, SDK methods, token usage, error handling |
| [Privacy Model](docs/PRIVACY-MODEL.md) | Sanitisation layers, PII detection, threat model |
| [Configuration](docs/CONFIGURATION.md) | Valves, env variables, memory management, lifecycle hooks |

